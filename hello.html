<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Camera</title>
    <link rel="stylesheet" href="style2.css" />
  </head>
  <body>
    <div id="wrapper">
      <div id="container">
        <video autoplay muted playsinline id="camera"></video>
        <!-- fram -->
        <canvas id="frame" width="600" height="600"></canvas>

        <div id="shutter-inner">
          <button id="btn-shutter" type="button">
            <img src="icon/camera-solid.png" width="150" height="150" />
          </button>
        </div>
        <audio id="se" preload="auto">
          <source src="se/camera-shutter1.mp3" type="audio/mp3" />
        </audio>
      </div>
      <canvas
        id="still"
        width="860"
        height="480"
        style="display: none"
      ></canvas>
    </div>
  </body>
  <script>
    const VIDEO = document.querySelector("#camera"); // <video>
    const FRAME = document.querySelector("#frame"); // <canvas>
    const width = document.querySelector("#container").offsetWidth;
    const hight = document.querySelector("#container").offsetHeight;

    // Get the button that opens the modal
    var btn = document.getElementById("btn-shutter");

    /** フレーム素材一覧 */
    let FRAMES = [
      {
        large: "image/w.png",
        small: "image/w.png",
      },
    ];

    /** カメラ設定 */
    const CONSTRAINTS = {
      audio: false,
      video: {
        width: 1920,
        height: 1080,
        aspectRatio: 1.7777777778,
        // facingMode: "user", // フロントカメラを利用する
        facingMode: { exact: "environment" }, // リアカメラを利用する場合
      },
    };

    // onload

    window.onload = () => {
      sysncCamera();
      VIDEO.play();

      // drawFrame
      drawFrame(FRAMES[0].large);

      document.querySelector("#btn-shutter").addEventListener("click", () => {
        // Pause
        VIDEO.pause();
        SE.play();

        // ConcatCanvas => result
        onShutter();
        concatCanvas("#result", ["#still", "#frame"]);
      });
    };

    async function sysncCamera() {
      try {
        await navigator.mediaDevices
          .getUserMedia(CONSTRAINTS)
          .then((stream) => {
            VIDEO.srcObject = stream;
            VIDEO.play();
          })
          .catch((err) => {
            console.log(err);
          });
      } catch (err) {
        alert("Could not asscess the camera!");
      }
    }

    function drawFrame(path) {
      const image = new Image();
      image.src = path;
      image.load = () => {
        const ctx = FRAME.getContext("2d");
        ctx.clearRect(0, 0, frame.width, frame.height);
        ctx.drawImage(image, 0, 0, frame.width, frame.height);
      };
    }

    function onShutter() {
      const ctx = STILL.getContext("2d");
      // 前回の結果を消去
      ctx.clearRect(0, 0, STILL.width, STILL.height);

      // videoを画像として切り取り、canvasに描画
      ctx.drawImage(VIDEO, 0, 0, STILL.width, STILL.height);
    }

    
  </script>
</html>
