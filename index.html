<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Demo</title>
  <link rel="stylesheet" href="style.css" type="text/css" media="all">
  <style>
    #camera {
      z-index: 1;
      position: fixed;
      right: 0;
      bottom: 0;
      min-width: 100%; 
      min-height: 100%;
    }

    #frame {
      position: absolute;
      z-index: 10;
      transform: skew(10deg);
      top: 46%;
      left: 21%;
    }

    #still {
      display: none;
    }
    #result {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="wrapper">
    <section id="contents">
      <!-- カメラ映像 -->

      <video id="camera" autoplay muted playsinline></video>

      <div id="detail">
        <div class="wrapTitle">
            <p class="title">Watch Master</p>
            <img src="image/bannerTop.png" class="bannerTop"  />
        </div>
        <img src="icon/detail.png" class="detailImg"  />
      </div>
      <div id="product">
        <p class="name">SBGA211</p>
        <p class="product-overview">カメラ映像カメラ映像カメラ映像</p>
        <div class="product-detail">
          <p class="size">Case size: 41.0mm</p>
          <p class="tax">Y682,200 (tax inc.)</p>
        </div>
      </div>

      <div id="detailWatch">
        <img src="image/detailWatch.png" class="notiWatch" />
      </div>

      <div id="hand">
        <img src="icon/hand.png" width="100%" height="100%"/>
      </div>
      <!-- フレーム -->
      <canvas id="frame" width="320" height="320"></canvas>

      <!-- シャッター -->
      <div id="shutter-inner">
        <div class="container-shutter">
          <img src="image/shutterDetail.png" class="shutter-detail" />
        </div>
        <button id="btn-shutter" type="button"><img src="icon/camera-solid.png" width="200" height="200"></button>
      </div>

      <!-- フレーム切り替え -->
      <div id="frame-inner" style="display: none;">
        <h2>フレーム切り替え</h2>
        <ul id="framelist">
        </ul>
      </div>
    </section>

    <!-- 合成用Canvas(不可視) -->
    <canvas id="still" width="640" height="480"></canvas>

    <!-- ダイアログ -->
    <div id="dialog-outer">
      <!-- 最終結果 -->
      <div id="dialog-result" class="dialog">
        <p>
          <img id="dialog-result-close" src="icon/times-circle-regular.png" width="48" height="48">
        </p>
        <div id="wrapImg">
          <canvas id="frameResult" width="250" height="250"></canvas>
          <canvas id="resultImg" ></canvas>
        </div>
        <div class="btnBottom">
          <button id="dialog-result-dl" type="button">
            <img src="icon/download-solid.png" width="48" height="48">
          </button>
        </div>
      </div>

      <!--  NowLoading -->
      <div id="dialog-nowloading" class="dialog">
        ...Now Loading
      </div>
    </div>
    <!-- /ダイアログ -->

    <audio id="se" preload="auto">
      <source src="se/camera-shutter1.mp3" type="audio/mp3">
    </audio>

  </div>

  <script src="util.js" type="text/javascript"></script>
  <script>
    //-----------------------------------------------------
    // グローバル変数
    //-----------------------------------------------------
    const VIDEO = document.querySelector("#camera"); // <video>
    const FRAME = document.querySelector("#frame"); // <canvas>
    const FRAMERESULT = document.querySelector("#frameResult"); // <canvas>
    const RESULTIMG = document.querySelector("#resultImg");
    const STILL = document.querySelector("#still"); // <canvas>
    const SE = document.querySelector('#se');
    let w = window.innerWidth;
    let h = window.innerHeight;
    const WH = {
      width: w,
      height: h
    };

    console.log(w,h)
    /** フレーム素材一覧 */
    const FRAMES = [{
      large: "image/watch.png",
      small: "image/w.png"
    }];

    /** カメラ設定 */
    const CONSTRAINTS = {
      audio: false,
      video: {
        width: 1920,
        height: 1080,
        facingMode: "user" // フロントカメラを利用する
        // facingMode: { exact: "environment" }  // リアカメラを利用する場合
      }
    };

    //-----------------------------------------------------
    // onload
    //-----------------------------------------------------
    window.onload = () => {
      //-----------------------------
      //カメラを<video>と同期
      //-----------------------------
      syncCamera();
      VIDEO.play();

      //-----------------------------
      // フレーム初期化
      //-----------------------------
      drawFrame(FRAMES[0].large); // 初期フレームを表示
      drawFrameCopy(FRAMES[0].large)
      setFrameList(); // 切り替え用のフレーム一覧を表示

      //-----------------------------
      // シャッターボタン
      //-----------------------------
      document.querySelector("#btn-shutter").addEventListener("click", () => {
        // SE再生＆映像停止
        VIDEO.pause();
        SE.play();

        // 画像の生成
        onShutter(); // カメラ映像から静止画を取得
        // concatCanvas("#result", ["#still", "#frame"], WH); // フレームと合成

        // 最終結果ダイアログを表示
        setTimeout(() => { // 演出目的で少しタイミングをずらす
          dialogShow("#dialog-result");
        }, 300);
      });

      //-----------------------------
      // ダイアログ
      //-----------------------------
      // 閉じるボタン
      document.querySelector("#dialog-result-close").addEventListener("click", (e) => {
        VIDEO.play();
        dialogHide("#dialog-result");
      });

      // ダウンロードボタン
      document.querySelector("#dialog-result-dl").addEventListener("click", (e) => {
        canvasDownload("#result");
      });
    };

    /**
     * [onload] カメラを<video>と同期
     */

    async function syncCamera() {
      try {
        await navigator.mediaDevices.getUserMedia(CONSTRAINTS)
          .then((stream) => {
            VIDEO.srcObject = stream;
            VIDEO.play();
          })
          .catch((err) => {
            console.log(`${err.name}: ${err.message}`);
          });
      } catch (err) {
        alert("Could not access the camera!");
      }
    }

    /**
     * [onload] フレーム一覧を表示する
     *
     * @return {void}
     **/
    function setFrameList() {
      const list = document.querySelector("#framelist");
      let i = 0;
      FRAMES.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `<img src="${item.small}">`; // <li><img ...></li>
        li.classList.add("framelist"); // <li class="framelist" ...
        li.setAttribute("data-index", i++); // <li data-index="1" ...

        // クリックされるとフレーム変更
        li.addEventListener("click", (e) => {
          const idx = e.target.parentElement.getAttribute("data-index"); // 親(parent)がli
          drawFrame(FRAMES[idx].large);
        })

        // ulに追加
        list.appendChild(li);
      });
    }

    /**
     * 指定フレームを描画する
     *
     * @param {string} path  フレームの画像URL
     * @return {void}
     */
    function drawFrame(path) {
      const modal = "#dialog-nowloading";
      const image = new Image();
      image.src = path;
      image.onload = () => {
        const ctx = FRAME.getContext("2d");
        ctx.clearRect(0, 0, frame.width, frame.height);
        ctx.drawImage(image, 0, 0, frame.width, frame.height);

        setTimeout(() => {
          dialogHide(modal);
        }, 100);
      };
      dialogShow(modal);
    }

    function drawFrameCopy(path) {
      const modal = "#dialog-nowloading";
      const image = new Image();
      image.src = path;
      image.onload = () => {
        const ctx = FRAMERESULT.getContext("2d");
        ctx.clearRect(0, 0, frameResult.width, frameResult.height);
        ctx.drawImage(image, 0, 0, frameResult.width, frameResult.height);

        setTimeout(() => {
          dialogHide(modal);
        }, 100);
      };
      dialogShow(modal);
    }

    /**
     * シャッターボタンをクリック
     *
     * @return {void}
     **/
    function onShutter() {
      const ctx = RESULTIMG.getContext("2d");
      console.log(RESULTIMG.width, RESULTIMG.height ,'RESULTIMG')
      // 前回の結果を消去
      ctx.clearRect(0, 0, RESULTIMG.width, RESULTIMG.height);

      // videoを画像として切り取り、canvasに描画
      ctx.drawImage(VIDEO, 0, 0, RESULTIMG.width, RESULTIMG.height);
    }

    /**
     * ダイアログを表示
     *
     * @param {string} id
     **/
    function dialogShow(id) {
      document.querySelector("#dialog-outer").style.display = "block";
      document.querySelector(id).style.display = "block";
    }

    /**
     * ダイアログを非表示
     *
     * @param {string} id
     **/
    function dialogHide(id) {
      document.querySelector("#dialog-outer").style.display = "none";
      document.querySelector(id).style.display = "none";
    }
  </script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143297-8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-143297-8');
  </script>

  <iframe src="./saved_resource.html" style="display: none;"></iframe> -->
</body>

</html>
</body>

</html>